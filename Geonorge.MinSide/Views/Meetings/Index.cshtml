@using Geonorge.MinSide.Services.Authorization;
@using Microsoft.AspNetCore.Http;
@using Geonorge.MinSide.Utils;
@model MeetingViewModel

@{
    ViewData["Title"] = "Møter";
}
<div class="container">
    <h2>Møter  @Context.Session.GetString("OrganizationName")</h2>
    @if (User.IsInRole(GeonorgeRoles.MetadataAdmin))
    {
    <p>
        <a asp-action="Create" class="btn no-margin-bottom show-loading-animation">Nytt møte</a>
        @if (Model.Last != null) {
            <span></span> <a asp-action="Edit" class="btn no-margin-bottom show-loading-animation" asp-route-id="@Model.Last.Id">Rediger dette møtet</a>
        }
    </p>
    }

    @if (Model.Last != null)
    {
        <div class="row">
            <div class="col-12"><h4>Pågående møte</h4></div>
            <div class="col-12">
                <b>@Model.Last.Date.ToString("dd.MM.yyyy") @Html.DisplayFor(modelItem => Model.Last.Type)</b>
            </div>
            <div class="col-12">@Model.Last.Description</div>
       
                        
       

            <div class="col-12">
                <b>Dokumenter:</b>
                <ul>
                    @foreach (var file in Model.Last.Documents)
                    {
                        <li><a asp-action="Download" asp-controller="Documents" asp-route-id="@file.Id">@Html.DisplayFor(modelItem => file.Name)</a></li>
                    }
                </ul>
           </div> 
        </div>
        <div class="row">
            <div class="col-12"><b>Oppfølgingspunkter:</b></div>
        </div>
        <div class="row">
            <div class="col-12">
                <form>
                    @{var Status = new SelectList(CodeList.ToDoStatus, "Key", "Value", ViewBag.Status);}
                    <select name="status" onchange="this.form.submit();" class="form-control" asp-items="Status"><option value="">Viser alle</option></select>
                </form>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <form asp-action="EditToDoList">
                    
                      
                       
                            @{int i = 0;}
                            @foreach (var todo in Model.Last.ToDo)
                            {
                               
                                
                                <div class="row form-layout @Helper.GetMeetingStatusClass(todo.Status)">
                                   
                                    
                                    
                                    @if (User.IsInRole(GeonorgeRoles.MetadataAdmin))
                                {
                                    <div class="col-4">
                                        <strong>Nr  <span>@todo.Number</span> - <span>@todo.Description</span></strong>
            
                                       <div>
                                            <label>Frist:</label>
                                        <span>@todo.Deadline.ToString("dd.MM.yyyy")</span>
                                         <label>Ansvarlig:</label>
                                        <span>@todo.ResponsibleOrganization</span>
                                        
                                        </div>
                                    </div>                                     <div class="col-3">
                                         <label>Status </label>
                                        @{var Status = new SelectList(CodeList.ToDoStatus, "Key", "Value", todo.Status);}
                                        <select name="ToDo[@i].Status" class="form-control" asp-items="Status"></select>
                                        
                                    </div>
                                    <div class="col-5">
                                        <div class="datepicker">
                                            <label>Utført dato</label>
                                            <input type="datetime" placeholder="dd.mm.yyyy" class="form-control" name="ToDo[@i].Done" value="@(todo.Done.HasValue ? todo.Done.Value.ToString("dd.MM.yyyy") : "")" />
                                        </div>
                                    </div>
                            
                                    
                                    
                                    <div class="col-12">
                                         <label>Kommentar</label>
                                        <textarea type="textarea" rows="2" class="form-control" name="ToDo[@i].Comment">@todo.Comment</textarea>
                                    </div>                                                                                                                                                
                                
                                    <input type="hidden" name="ToDo[@i].Id" value="@todo.Id" />
                                i++;
                                
                            
                            
                            
                                
                                
                                <div class="col-12">
                                    <input type="submit" value="Lagre" class="btn btn-default" />
                                </div>
                           
                           
                                }
                                     else {
                                         <div class="col-12">
                                        <strong>Nr  <span>@todo.Number</span> </strong> - <span>@todo.Description</span>
                                        <br /> Status: <strong>@(todo.Done.HasValue ? "Utført den " + todo.Done.Value.ToString("dd.MM.yyyy") : "") @todo.Status</strong>
                                       <div>
                                            <label class="not-bold">Frist:</label>
                                        <span><strong>@todo.Deadline.ToString("dd.MM.yyyy")</strong></span>
                                         <label class="not-bold">Ansvarlig:</label>
                                        <span><strong>@todo.ResponsibleOrganization</strong></span>
                                        
                                        </div>
                                    </div> 
                                    <div class="col-12">
                                     
                                        <div>@todo.Comment</div>
                                    </div>
                              
                            }
                            
                            </div>
                                
                            
                           
                        }
                    <input type="hidden" name="MeetingId" value="@Model.Last.Id" />
                 </form>
            </div>
        </div>
        <div class="row">
            <div class="col-2"><b>Konklusjon:</b></div>
        </div>
        <div class="row">
            <div class="col-10">@Model.Last.Conclusion</div>
        </div>
        <p></p>
        <div class="row">
            <div class="col-2"><b>Arkiv:</b></div>
        </div>
        <div class="row">
            <div class="col-10">
                @foreach (var meeting in Model.Archive)
                {
                    <b>@meeting.Date.ToString("dd.MM.yyyy") @Html.DisplayFor(modelItem => meeting.Type)</b>
                    <span>|</span> <a asp-action="Details" asp-route-id="@meeting.Id">Detaljer</a>
                    @if (User.IsInRole(GeonorgeRoles.MetadataAdmin))
                    {
                        <span>|</span> <a asp-action="Edit" asp-route-id="@meeting.Id">Rediger</a>
                    }
                    <br />
                }
            </div>
        </div>
    }
</div>
